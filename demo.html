---
layout: post
title: Try Terra
---
<link rel="stylesheet" href="stylesheets/codemirror.css">
<script src="javascripts/codemirror.js"></script>
<script src="javascripts/lua.js"></script>
<script src="javascripts/md5.js"></script>
<h1 id='installing_terra'>Try Terra</h1>
<div class="example" id="blurx.t" >
import "darkroom"
darkroomSimple = terralib.require("darkroomSimple")

a = darkroomSimple.load("color.bmp")
im a(x,y) [float[3]]( a(x,y) ) end

im blurx(x,y) 
  map i=-5,5 reduce(sum) a(x+i,y)/11 end
end

im blurx(x,y) [uint8[3]]( blurx ) end -- convert to 24 bit
blurx:save(arg[1]) -- write to arg[1] to display
</div>

<div class="example" id="bruteof.t">
import "darkroom"
darkroomSimple = terralib.require "darkroomSimple"

-- brute force optical flow

searchWindowRadius = 2
SADWindowRadius = 2

local frame1 = darkroomSimple.load("frame10.bmp")
frame1 = im(x,y) [int](frame1) end
local frame2 = darkroomSimple.load("frame11.bmp")
frame2 = im(x,y) [int](frame2) end

im bruteofVectorField(x,y)
  map i=-searchWindowRadius, searchWindowRadius j=-searchWindowRadius, searchWindowRadius reduce(argmin)
    -- sum of absolute differences (SAD)
    map ii=-SADWindowRadius, SADWindowRadius jj=-SADWindowRadius, SADWindowRadius reduce(sum)
      darkroom.abs(frame1(x+ii,y+jj)-frame2(x+i+ii,y+j+jj))
    end
  end
end

-- convert this to an RGB image so that the user can view it
im ofRGB(x,y) [uint8[3]]({(bruteofVectorField(x,y)[0])*50+128, (bruteofVectorField(x,y)[1])*50+128, 0}) end
ofRGB:save(arg[1])
</div>

<div class="example" id="pow.t">
--generate a power function for a specific N (e.g. N = 3)
function makePowN(N)
    local function emit(a,N)
        if N == 0 then return 1
      else return `a*[emit(a,N-1)]
      end
    end
    return terra(a : double)
        return [emit(a,N)]
    end
end

--use it to fill in a table of functions
local mymath = {}
for n = 1,10 do
    mymath["pow"..n] = makePowN(n)
end
print(mymath.pow3(2)) -- 8
</div>

<div class="example" id="templating.t">
C = terralib.includec("stdlib.h")
function MakeArray(T)
    --create a new Struct type that contains a pointer 
    --to a list of T's and a size N
    local struct ArrayT {
        --&T is a pointer to T
        data : &T;
        N : int;
    } 
    --add some methods to the type
    terra ArrayT:init(N : int)
        -- the syntax [&T](...) is a cast,
        -- the C equivalent is (T*)(...)
        self.data = [&T](C.malloc(sizeof(T)*N))
        self.N = N
    end
    terra ArrayT:get(i : int)
        return self.data[i]
    end
    terra ArrayT:set(i : int, v : T)
        self.data[i] = v
    end
    --return the type as a 
    return ArrayT
end

IntArray = MakeArray(int)
DoubleArray = MakeArray(double)

terra UseArrays()
    var ia : IntArray
    var da : DoubleArray
    ia:init(1) 
    da:init(1)
    ia:set(0,3)
    da:set(0,4.5)
    return ia:get(0) + da:get(0)
end
print(UseArrays())
</div>

<div class="example" id="bfcompiler.t" >
local C = terralib.includec("stdio.h")

local function compile(code,N)
	local function body(data,ptr)
		local stmts = terralib.newlist()
		local jumpstack = {}
		for i = 1,#code do
			local c = code:sub(i,i)
			local stmt
			if c == ">" then
				stmt = quote ptr = ptr + 1 end
			elseif c == "<" then
				stmt = quote ptr = ptr - 1 end
			elseif c == "+" then
				stmt = quote data[ptr] = data[ptr] + 1 end
			elseif c == "-" then
				stmt = quote data[ptr] = data[ptr] - 1 end
			elseif c == "." then
				stmt = quote C.putchar(data[ptr]) end
			elseif c == "," then
				stmt = quote data[ptr] = C.getchar() end
			elseif c == "[" then
				local target = { before = symbol(), 
				                 after = symbol() }
				table.insert(jumpstack,target)
				stmt = quote 
					::[target.before]:: 
					if data[ptr] == 0 then
						goto [target.after]
					end
				end
			elseif c == "]" then
				local target = table.remove(jumpstack)
				assert(target)
				stmt = quote 
					goto [target.before]
					:: [target.after] ::
				end
			else
				error("unknown character "..c)
			end
			stmts:insert(stmt)
		end
		return stmts
	end
	return terra()
		var data : int[N]
		for i = 0, N do
			data[i] = 0
		end
		var ptr = 0;
		[ body(data,ptr) ]
	end
end

local helloworld = "++++++++++[>+++++++>++++++++++>+++>+<<<<-]>++.>+.+++++++..+++.>++.<<+++++++++++++++.>.+++.------.--------.>+.>."

local fn = compile(helloworld,256)

fn()
</div>












<div style="float:right;">
<select id="examples" onchange="updatecontent()">
</select>
</div>
<br/>
<div id="editor">
</div>
<script>
var codemirror = CodeMirror(document.getElementById("editor"), {
  value: "",
  lineNumbers: true,
  lineWrapping: false,
  smartIndent: false,
  tabSize: 2,
  mode:  "lua"
});
function updatecontent() {
	var o = document.getElementById("examples")
	var name = o.options[o.selectedIndex].value
	var content = document.getElementById(name).textContent
	codemirror.setValue(content.replace(/^\n/,""))
	codemirror.setCursor(codemirror.lineCount(),0)
	codemirror.focus()
}
function finishresult(data) {
	var r = document.getElementById("result")
	var code = document.createElement("code")
	code.textContent = atob(data)
	var pre = document.createElement("pre")
	pre.appendChild(code)
	r.innerHTML = ""
	r.appendChild(pre)

//	var code = document.createElement("code")
//	code.textContent = md5(codemirror.getValue())
//  r.appendChild(code)

	var i = document.createElement("img")
  i.setAttribute('src', "http://candela.stanford.edu:4002/" + md5(codemirror.getValue()) + '.bmp');
	r.appendChild(i)
}
function execute() {
	var script = document.createElement("script")
	script.type = "text/javascript"
	var data = btoa(codemirror.getValue())
	script.src = "http://candela.stanford.edu:4002/" + data 
	document.getElementById("result").appendChild(script)
}
var selector = document.getElementById("examples")
var examples = document.getElementsByClassName("example")
for (var i = 0; i < examples.length; i++) {
	var o = document.createElement("option")
	o.textContent = examples[i].id
	selector.appendChild(o)
}
updatecontent()
</script>
<br>
<button type="button" style="float:right;" onclick="execute()">Execute</button>
<br>
<br>
<hr>
<div id="result"></div>
